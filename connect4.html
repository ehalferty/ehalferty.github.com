<html><canvas id="canvas" width="350" height="400"></canvas>
<p>Right/left arrows to move. D to drop a piece. R to reset the game.</p>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="http://raw.github.com/caleb531/jcanvas/master/builds/6.0/jcanvas.min.js" type="text/javascript"></script>
<script type="text/javascript">

// Game variables
var board = [];
var playerCol;
var gameOver;
var statusMessage;
var winner;
var winSquares = [];
var w;

// Initialization
$("document").ready(function() { resetGame(); });

// Reset game
function resetGame() {

	// Clear the game board
	for (var i = 0; i < 7; i++) {
		board[i] = ['.', '.', '.', '.', '.', '.'];
	}
	winSquares.length = 0;
	
	// Reset the player position
	playerCol = 3;
	gameOver = false;
	statusMessage = "Game in progress. Your turn!";
	
	// Redraw
	updateCanvas();
}

// Handle keyboard input
$(document).keydown( function(e){
	if (!gameOver) {
		if (e.keyCode == 37) {
			if (playerCol > 0) playerCol--;
		} else if (e.keyCode == 39) {
			if (playerCol < 6) playerCol++;
		} else if (e.keyCode == 68) {
			dropPlayerPiece(playerCol);
		}
	}
	if (e.keyCode == 82) {
		resetGame();
	}
	// Redraw
	updateCanvas();
});

function dropPlayerPiece(col) {
	if (canDrop(col)) {
		dropGamePiece(col, "b");
		if (!gameOver) statusMessage = "Game in progress. Your turn!";
		var AICol = Math.floor(Math.random()*7);
		while (!canDrop(AICol)) {
			AICol = Math.floor(Math.random()*7);
		}
		if (!gameOver) dropGamePiece(AICol, "r");
	} else {
		statusMessage = "That column is full!";
	}
}

function checkWinCondition() {
	largeBoard = [];
	for (var i = 0; i < 13; i++) {
		largeBoard[i] = ['.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.'];
	}
	
	for (var i = 0; i < 7; i++) {
		for (var j = 0; j < 6; j++) {
			largeBoard[i + 3][j + 3] = board[i][j];
		}
	}
	w  = '.';
	win:
	for (var i = 3; i < 10; i++) {
		for (var j = 3; j < 9; j++) {
			var square = largeBoard[i][j];
			if (largeBoard[i][j + 1] == square &&
				largeBoard[i][j + 2] == square &&
				largeBoard[i][j + 3] == square) {
				w = square;
				winSquares = [[i, j], [i, j + 3]];
			}
			if (largeBoard[i][j - 1] == square &&
				largeBoard[i][j - 2] == square &&
				largeBoard[i][j - 3] == square) {
				w = square;
				winSquares = [[i, j], [i, j - 3]];
			}
			if (largeBoard[i + 1][j] == square &&
				largeBoard[i + 2][j] == square &&
				largeBoard[i + 3][j] == square) {
				w = square;
				winSquares = [[i, j], [i + 3, j]];
			}
			if (largeBoard[i - 1][j] == square &&
				largeBoard[i - 2][j] == square &&
				largeBoard[i - 3][j] == square) {
				w = square;
				winSquares = [[i, j], [i - 3, j]];
			}
			
			if (largeBoard[i + 1][j + 1] == square &&
				largeBoard[i + 2][j + 2] == square &&
				largeBoard[i + 3][j + 3] == square) {
				w = square;
				winSquares = [[i, j], [i + 3, j + 3]];
			}
			if (largeBoard[i + 1][j - 1] == square &&
				largeBoard[i + 2][j - 2] == square &&
				largeBoard[i + 3][j - 3] == square) {
				w = square;
				winSquares = [[i, j], [i + 3, j - 3]];
			}
			if (largeBoard[i - 1][j + 1] == square &&
				largeBoard[i - 2][j + 2] == square &&
				largeBoard[i - 3][j + 3] == square) {
				w = square;
				winSquares = [[i, j], [i - 3, j + 3]];
			}
			if (largeBoard[i - 1][j - 1] == square &&
				largeBoard[i - 2][j - 2] == square &&
				largeBoard[i - 3][j - 3] == square) {
				w = square;
				winSquares = [[i, j], [i - 3, j - 3]];
			}
			if (w != '.') {
				break win;
			}
		}
	}
	if (w != '.') {
		gameOver = true;
		statusMessage = w + "wins";
		
		updateCanvas();
	}
}

function dropGamePiece(col, piece) {
	for(i = 5; i >= 0; i--) {
		if (board[col][i] == ".") {
			board[col][i] = piece;
			checkWinCondition();
			break;
		}
	}
}

function canDrop(col) {
	return (board[col][0] == ".");
}

function updateCanvas() {
	
	// Clear canvas.
	$("canvas").drawRect({
		fillStyle: 'silver',
		cornerRadius: 10,
		x: 175,
		y: 200,
		height: 400,
		width: 350
	});
	
	// Draw game board squares
	for (var i = 0; i < 7; i++) {
		for (var j = 0; j < 6; j++) {
			$("canvas").drawRect({
				fillStyle: 'black',
				cornerRadius: 10,
				x: i * 50 + 25,
				y: j * 50 + 75,
				height: 49,
				width: 49
			});
			
			// Draw pieces
			if (board[i][j] != '.') {
				$("canvas").drawEllipse({
					fillStyle: ((board[i][j] == 'r')? 'red' : 'blue'),
					x: i * 50 + 25,
					y: j * 50 + 75,
					height: 40,
					width: 40
				});
			}
		}
	}
	
	// Draw player cursor
	$("canvas").drawPolygon({
		x: playerCol * 50 + 25,
		y: 20,
		strokeStyle: "blue",
		strokeWidth: 4,
		radius: 20,
		rotate: 180,
		sides: 3,
	});
	
	// Draw game status message
	$("canvas").drawText({
		fillStyle: 'black',
		strokeWidth: 2,
		x: 175,
		y: 375,
		font: "14pt Arial",
		text: statusMessage
	});
	
	// Draw winning squares (if any)
	if (gameOver) {
		var rectanglePoints = [];
		
		
		// Vertical win
		if (winSquares[0][0] == winSquares[1][0]) {
			var x = winSquares[0][0] - 3;
			var y = 0;
			if (winSquares[0][1] < winSquares[1][1]) {
				y = winSquares[0][1] - 3; 
			} else {
				y = winSquares[1][1] - 3; 
			}
			rectanglePoints[0] = [x * 50, y * 50 + 50];
			rectanglePoints[1] = [x * 50 + 50, y * 50 + 50];
			rectanglePoints[2] = [x * 50 + 50, y * 50 + 250];
			rectanglePoints[3] = [x * 50, y * 50 + 250];
		}
		
		// Horizontal win
		else if (winSquares[0][1] == winSquares[1][1]) {
			var x = 0;
			var y = winSquares[0][1] - 3;
			if (winSquares[0][0] < winSquares[1][0]) {
				x = winSquares[0][0] - 3; 
			} else {
				x = winSquares[1][0] - 3; 
			}
			rectanglePoints[0] = [x * 50, y * 50 + 50];
			rectanglePoints[1] = [x * 50 + 200, y * 50 + 50];
			rectanglePoints[2] = [x * 50 + 200, y * 50 + 100];
			rectanglePoints[3] = [x * 50, y * 50 + 100];
		}
		
		// Diagonal win, first point on top
		else if (winSquares[0][1] < winSquares[1][1]) {
			var x = winSquares[1][0] - 3;
			var y = winSquares[1][1] - 3;
			rectanglePoints[0] = [x * 50 + 60, y * 50 + 75];
			rectanglePoints[1] = [x * 50 + 25, y * 50 + 110];
			rectanglePoints[2] = [x * 50 + 25 - 185, y * 50 + 110 - 185];
			rectanglePoints[3] = [x * 50 + 60 - 185, y * 50 + 75 - 185];
		}
		
		// Diagonal win, first point on bot
		else if (winSquares[0][1] > winSquares[1][1]) {
			var x = winSquares[1][0] - 3;
			var y = winSquares[1][1] - 3;
			rectanglePoints[0] = [x * 50 + 25, y * 50 + 40];
			rectanglePoints[1] = [x * 50 + 60, y * 50 + 75];
			rectanglePoints[2] = [x * 50 + 55 - 180, y * 50 + 80 + 180];
			rectanglePoints[3] = [x * 50 + 20 - 180, y * 50 + 45 + 180];
		}
		
		if (rectanglePoints.length > 3) {
			$("canvas").drawLine({
				strokeStyle: ((w == 'r')? 'red' : 'blue'),
				strokeWidth: 4,
				rounded: true,
				x1: rectanglePoints[0][0], y1: rectanglePoints[0][1],
				x2: rectanglePoints[1][0], y2: rectanglePoints[1][1],
				x3: rectanglePoints[2][0], y3: rectanglePoints[2][1],
				x4: rectanglePoints[3][0], y4: rectanglePoints[3][1],
				x5: rectanglePoints[0][0], y5: rectanglePoints[0][1]
			});
			
		}
	}
}


</script></html>